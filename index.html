<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>طلب صيانة</title>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Tahoma', sans-serif;
      background-color: #f4f6fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #003366;
      margin-bottom: 30px;
      border-bottom: 2px solid #003366;
      padding-bottom: 10px;
    }

    .form-section, .invoice-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }

    button {
      background-color: #003366;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      margin-top: 15px;
      padding: 12px;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #004080;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .col {
      flex: 1;
      min-width: 200px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 16px;
    }

    table th, table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }

    table th {
      background-color: #003366;
      color: white;
      font-weight: bold;
    }

    table tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    .logo-preview {
      height: 100px;
      margin-top: 10px;
      display: block;
    }

    #printArea {
      display: none;
    }

    .pagination {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .pagination button {
      width: auto;
      padding: 8px 15px;
      margin: 0 5px;
    }

    .login-container {
      max-width: 400px;
      margin: 50px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .login-title {
      text-align: center;
      color: #003366;
      margin-bottom: 20px;
    }

    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid transparent;
      border-radius: 4px;
      text-align: center;
    }

    .alert-danger {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }

    .hidden {
      display: none;
    }

    .datalist-input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }

    /* تنسيق معلومات المؤسسة */
    .company-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(to right, #003366, #004080);
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .company-info {
      text-align: right;
    }

    .company-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .company-details {
      font-size: 16px;
    }

    .company-detail-item {
      margin-bottom: 5px;
      direction: rtl; /* Ensures RTL flow for the whole line */
      text-align: right; /* Aligns text to the right */
      white-space: nowrap; /* Prevents numbers from wrapping */
    }

    .company-detail-item span {
      display: inline-block; /* Allows inline positioning without float issues */
    }

    .company-logo {
      height: 100px;
    }

    /* تنسيق الطباعة */
    @media print {
      body {
        visibility: hidden;
        margin: 0;
        padding: 0;
      }

      #printArea {
        display: block !important;
        visibility: visible;
        width: 100%;
        height: auto;
        position: absolute;
        top: 0;
        right: 0;
        padding: 20px;
        background: white;
      }

      @page {
        size: A4;
        margin: 15mm;
      }

      /* إزالة الروابط من الطباعة */
      a, a:link, a:visited, a:hover, a:active {
        display: none !important;
      }

      .print-header {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
      }

      .print-header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
      }

      .print-title {
        text-align: center;
        color: #003366;
        margin: 0;
        font-size: 24px;
      }

      .print-company-details {
        text-align: right;
        margin-top: 15px;
        font-size: 16px;
        direction: rtl;
      }

      .print-company-details div {
        margin-bottom: 8px;
        text-align: right;
        white-space: nowrap; /* Prevents numbers from wrapping in print */
      }

      .print-company-details div span {
        display: inline-block; /* Allows inline positioning without float issues */
      }

      .print-logo {
        height: 100px;
      }

      .print-date {
        text-align: left;
        font-size: 14px;
        color: #666;
        margin-top: 10px;
      }

      .print-table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
        background-color: white;
      }

      .print-table th {
        background-color: #003366 !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        padding: 10px;
        border: 1px solid #ddd;
      }

      .print-table td {
        padding: 10px;
        border: 1px solid #ddd;
        background-color: white;
      }

      .no-print {
        display: none !important;
      }
    }
  </style>
</head>
<body>

  <div id="loginSection" class="login-container">
    <h2 class="login-title">نظام إدارة المركبات</h2>
    <div id="loginError" class="alert alert-danger hidden">
      اسم المستخدم أو كلمة المرور غير صحيحة!
    </div>
    <form id="loginForm">
      <label for="username">اسم المستخدم:</label>
      <input type="text" id="username" placeholder="أدخل اسم المستخدم" required>
      
      <label for="password">كلمة المرور:</label>
      <input type="password" id="password" placeholder="أدخل كلمة المرور" required>
      
      <button type="button" onclick="login()">تسجيل الدخول</button>
    </form>
  </div>

  <div id="mainContent" class="hidden">
    <h1>طلب صيانة</h1>

    <div class="company-header">
      <div class="company-info">
        <div class="company-name" id="currentCompanyName">مؤسسة هند عطية</div>
        <div class="company-details">
          <div class="company-detail-item">السجل التجاري: <span id="currentCommercialRegister">205012619</span></div>
          <div class="company-detail-item">الرقم الضريبي: <span id="currentTaxNumber">302120852100003</span></div>
        </div>
      </div>
      <img id="mainLogo" class="company-logo" src="https://i.imgur.com/8SUC13Y.png" alt="شعار الشركة">
    </div>

    <div class="form-section">
      <div class="row">
        <div class="col">
          <label>اختيار المؤسسة:</label>
          <select id="companySelect" onchange="changeCompany()">
            <option value="hinda">مؤسسة هند عطية</option>
            <option value="mim">مؤسسة ميم</option>
          </select>
        </div>
        <div class="col">
          <label>اختيار الشعار:</label>
          <select id="logoSelect">
            <option value="https://i.imgur.com/8SUC13Y.png">الزهراني</option>
            <option value="https://i.imgur.com/yS26oQZ.png">ميم</option>
          </select>
          <img id="logoPreview" class="logo-preview" src="https://i.imgur.com/8SUC13Y.png" alt="شعار الشركة">
        </div>
      </div>
    </div>

    <div class="search-section">
      <h3 style="margin-top: 0;">بحث عن مركبة</h3>
      <div class="search-row">
        <input type="text" id="searchPlate" placeholder="ابحث برقم اللوحة">
        <button onclick="searchByPlate()">بحث</button>
        <button onclick="resetSearch()" style="background: #6c757d;">إعادة تعيين</button>
      </div>
    </div>

    <div class="form-section">
      <div class="row">
        <div class="col">
          <label>الخدمة:</label>
          <input type="text" id="service" placeholder="أدخل نوع الخدمة">
        </div>
        <div class="col">
          <label>رقم اللوحة:</label>
          <input type="text" id="plate" placeholder="أدخل رقم اللوحة">
        </div>
        <div class="col">
          <label>المنطقة:</label>
          <input list="regions" id="region" class="datalist-input" placeholder="اكتب أو اختر المنطقة">
          <datalist id="regions">
            <option value="الرياض">
            <option value="جدة">
            <option value="مكة المكرمة">
            <option value="المدينة المنورة">
            <option value="الدمام">
            <option value="الخبر">
            <option value="الظهران">
            <option value="بريدة">
            <option value="تبوك">
            <option value="الطائف">
            <option value="حائل">
            <option value="أبها">
            <option value="نجران">
            <option value="جازان">
            <option value="سكاكا">
            <option value="عرعر">
            <option value="القريات">
            <option value="النعيرية">
            <option value="رفحاء">
            <option value="ضباء">
            <option value="الليث">
            <option value="القنفذة">
            <option value="بيشة">
            <option value="محايل عسير">
            <option value="خميس مشيط">
            <option value="الخرج">
            <option value="الدوادمي">
            <option value="وادي الدواسر">
            <option value="الأحساء">
            <option value="حفر الباطن">
            <option value="القطيف">
            <option value="ينبع">
            <option value="العلا">
            <option value="رابغ">
            <option value="الباحة">
            <option value="الزلفي">
            <option value="الرس">
            <option value="عنيزة">
            <option value="المجمعة">
            <option value="الخفجي">
            <option value="طريف">
            <option value="الدرب">
            <option value="صبيا">
            <option value="أحد رفيدة">
            <option value="بلجرشي">
            <option value="المهد">
            <option value="الوجه">
            <option value="أملج">
            <option value="بدر">
            <option value="الحريق">
            <option value="حوطة بني تميم">
            <option value="الغاط">
            <option value="السليل">
            <option value="ضرما">
            <option value="المزاحمية">
          </datalist>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>تاريخ الطلب:</label>
          <input type="date" id="date">
        </div>
        <div class="col">
          <label>المسافة المقطوعة (كم):</label>
          <input type="number" id="distance" placeholder="أدخل المسافة بالكيلومترات">
        </div>
        <div class="col">
          <label>ملاحظات:</label>
          <input type="text" id="notes" placeholder="أدخل أي ملاحظات إضافية">
        </div>
      </div>
      <button onclick="addInvoice()">إضافة الفاتورة</button>
      
      <div class="form-section" style="margin-top: 20px;">
        <h3>رفع ملف Excel</h3>
        <input type="file" id="excelUpload" accept=".xls, .xlsx">
        <button onclick="handleExcelUpload()">رفع وتحميل البيانات</button>
      </div>

    </div>

    <div class="invoice-section">
      <div class="row">
        <div class="col">
          <label>اختيار اللوحات للطباعة:</label>
          <select id="plateSelect" multiple size="5" style="height: 120px; width: 100%;"></select>
        </div>
        <div class="col" style="display: flex; align-items: flex-end;">
          <button onclick="printSelected()" style="width: 100%;">طباعة PDF</button>
        </div>
      </div>

      <div class="pagination">
        <button onclick="prevPage()">«</button>
        <button onclick="prevPage()">< السابق</button>
        <span style="padding: 8px 15px; margin: 0 5px;">1 من 2</span>
        <button onclick="nextPage()">التالي ></button>
        <button onclick="nextPage()">»</button>
      </div>

      <table id="invoiceTable">
        <thead>
          <tr>
            <th>الخدمة</th>
            <th>رقم اللوحة</th>
            <th>المنطقة</th>
            <th>تاريخ الطلب</th>
            <th>المسافة (كم)</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="printArea"></div>
  </div>

  <script>
    // بيانات المؤسسات
    const companies = {
      hinda: {
        name: "مؤسسة هند عطية",
        commercialRegister: "205012619", // تم التحديث
        taxNumber: "302120852100003",
        logo: "https://i.imgur.com/8SUC13Y.png"
      },
      mim: {
        name: "مؤسسة ميم",
        commercialRegister: "4030385483", // تم التحديث
        taxNumber: "311054471900003", // تم التحديث
        logo: "https://i.imgur.com/yS26oQZ.png"
      }
    };

    // البيانات العامة
    const data = [];
    let currentPage = 1;
    const itemsPerPage = 5;
    let loggedIn = false;
    let regionsList = [
      "الرياض", "جدة", "مكة المكرمة", "المدينة المنورة", "الدمام",
      "الخبر", "الظهران", "بريدة", "تبوك", "الطائف",
      "حائل", "أبها", "نجران", "جازان", "سكاكا",
      "عرعر", "القريات", "النعيرية", "رفحاء", "ضباء",
      "الليث", "القنفذة", "بيشة", "محايل عسير", "خميس مشيط",
      "الخرج", "الدوادمي", "وادي الدواسر", "الأحساء", "حفر الباطن",
      "القطيف", "ينبع", "العلا", "رابغ", "الباحة",
      "الزلفي", "الرس", "عنيزة", "المجمعة", "الخفجي",
      "طريف", "الدرب", "صبيا", "أحد رفيدة", "بلجرشي",
      "المهد", "الوجه", "أملج", "بدر", "الحريق",
      "حوطة بني تميم", "الغاط", "السليل", "ضرما", "المزاحمية"
    ];

    // دالة تسجيل الدخول
    function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      
      if (username === "مشرف" && password === "00") {
        document.getElementById("loginError").classList.add("hidden");
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("mainContent").classList.remove("hidden");
        loggedIn = true;
      } else {
        document.getElementById("loginError").classList.remove("hidden");
      }
    }

    // تغيير المؤسسة
    function changeCompany() {
      const companySelect = document.getElementById("companySelect");
      const selectedCompany = companySelect.value;
      const company = companies[selectedCompany];
      
      document.getElementById("currentCompanyName").textContent = company.name;
      document.getElementById("currentCommercialRegister").textContent = company.commercialRegister;
      document.getElementById("currentTaxNumber").textContent = company.taxNumber;
      document.getElementById("mainLogo").src = company.logo;
      
      // تحديث الشعار
      document.getElementById("logoSelect").value = company.logo;
      document.getElementById("logoPreview").src = company.logo;
    }

    // دالة البحث برقم اللوحة
    function searchByPlate() {
      const searchTerm = document.getElementById("searchPlate").value.trim().toLowerCase();
      if (!searchTerm) {
        updateTable();
        return;
      }

      const filteredData = data.filter(item =>
        item.plate.toLowerCase().includes(searchTerm)
      );

      renderFilteredTable(filteredData);
    }

    // دالة إعادة تعيين البحث
    function resetSearch() {
      document.getElementById("searchPlate").value = "";
      updateTable();
    }

    // دالة لعرض الجدول بعد البحث
    function renderFilteredTable(filteredData) {
      const tbody = document.querySelector("#invoiceTable tbody");
      tbody.innerHTML = "";

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const paginatedData = filteredData.slice(start, end);

      paginatedData.forEach((item, index) => {
        const row = document.createElement("tr");
        // Ensure index matches the current data array, not just the paginated slice
        const actualIndex = data.findIndex(d => d === item); 
        row.innerHTML = `
          <td>${item.service}</td>
          <td>${item.plate}</td>
          <td>${item.region}</td>
          <td>${item.date}</td>
          <td>${parseFloat(item.distance).toFixed(2)}</td>
          <td>
            <button onclick="editRecord(${actualIndex})" class="action-btn edit-btn">تعديل</button>
            <button onclick="deleteRecord(${actualIndex})" class="action-btn delete-btn">حذف</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      updatePagination(filteredData.length);
    }

    // Helper function to format date
    function formatDateToYYYYMMDD(dateValue) {
        if (typeof dateValue === 'number' && !isNaN(dateValue)) {
            // Convert Excel date number (days since 1900-01-01) to JavaScript Date
            // Excel's 1900 date system considers 1900-02-29 as a valid date, which it isn't.
            // So, we subtract 1 day from the Excel date number if it's greater than 59 (Feb 28, 1900)
            // because Excel treats 1900 as a leap year.
            let days = dateValue;
            if (days > 60) { // Check for dates after Feb 28, 1900
                days--;
            }
            // Date object for Jan 1, 1900 (Excel's base date, day 1). Use UTC to avoid timezone issues.
            const excelEpoch = new Date('1900-01-01T00:00:00Z'); 
            excelEpoch.setDate(excelEpoch.getDate() + days - 1); // Subtract 1 because Excel day 1 is 1900-01-01, not 0
            
            return excelEpoch.toISOString().split('T')[0];

        } else if (typeof dateValue === 'string') {
            const parsedDate = new Date(dateValue);
            // Check for valid date string, including "yyyy-mm-dd"
            if (!isNaN(parsedDate.getTime())) {
                return parsedDate.toISOString().split('T')[0];
            }
            // Try parsing common European/Arabic formats (dd/mm/yyyy or dd-mm-yyyy) if direct parse fails
            const parts = dateValue.match(/^(\d{1,2})[/\-](\d{1,2})[/\-](\d{4})$/);
            if (parts) {
                const day = parseInt(parts[1]);
                const month = parseInt(parts[2]);
                const year = parseInt(parts[3]);
                // Assuming dd/mm/yyyy format for Arabic context
                const reParsedDate = new Date(year, month - 1, day); // Month is 0-indexed in JS
                if (!isNaN(reParsedDate.getTime())) {
                    return reParsedDate.toISOString().split('T')[0];
                }
            }
        }
        return ''; // Return empty string for invalid dates
    }

    // Helper function to parse distance
    function parseDistance(distanceValue) {
        const parsedDistance = parseFloat(distanceValue);
        return isNaN(parsedDistance) ? 0 : parsedDistance;
    }


    function addInvoice() {
      if (!loggedIn) {
        alert("يجب تسجيل الدخول أولاً");
        return;
      }

      const service = document.getElementById("service").value.trim();
      const plate = document.getElementById("plate").value.trim();
      const region = document.getElementById("region").value.trim();
      const date = document.getElementById("date").value; // This is already YYYY-MM-DD from input type="date"
      const distance = document.getElementById("distance").value.trim();
      const notes = document.getElementById("notes").value.trim();

      if (!service || !plate || !region || !date || !distance) {
        alert("يرجى تعبئة جميع الحقول المطلوبة.");
        return;
      }

      // Format date and distance for consistency
      const formattedDate = formatDateToYYYYMMDD(date);
      const parsedDistance = parseDistance(distance);

      // إذا كانت المنطقة جديدة نضيفها للقائمة
      if (!regionsList.includes(region)) {
        regionsList.push(region);
        updateRegionsDatalist();
      }

      const record = { service, plate, region, date: formattedDate, distance: parsedDistance, notes };
      data.push(record);

      updateTable();
      updatePlateSelect();

      // Reset inputs
      document.getElementById("service").value = "";
      document.getElementById("plate").value = "";
      document.getElementById("region").value = "";
      document.getElementById("date").value = "";
      document.getElementById("distance").value = "";
      document.getElementById("notes").value = "";
    }

    function updateRegionsDatalist() {
      const datalist = document.getElementById("regions");
      datalist.innerHTML = "";
      
      // Sort regions alphabetically for better user experience
      regionsList.sort().forEach(region => {
        const option = document.createElement("option");
        option.value = region;
        datalist.appendChild(option);
      });
    }

    function updateTable() {
      // Always reset current page to 1 when table data is updated
      // This ensures we start from the beginning of the new data set.
      currentPage = 1; 
      renderFilteredTable(data);
    }

    function updatePlateSelect() {
      const plateSelect = document.getElementById("plateSelect");
      plateSelect.innerHTML = "";
      
      // Get unique plates to avoid duplicates in the select dropdown
      const uniquePlates = [...new Set(data.map(item => item.plate))];
      uniquePlates.forEach(plate => {
        const option = document.createElement("option");
        option.value = plate;
        option.text = plate;
        plateSelect.appendChild(option);
      });
    }

    function updatePagination(totalItems = data.length) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      // Ensure currentPage doesn't exceed totalPages if data shrinks
      if (currentPage > totalPages && totalPages > 0) {
          currentPage = totalPages;
      } else if (totalPages === 0) { // Handle case with no data
          currentPage = 0;
      }
      const paginationText = `${currentPage === 0 ? 0 : currentPage} من ${totalPages}`;
      document.querySelector(".pagination span").textContent = paginationText;
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderFilteredTable(data); // Call renderFilteredTable to re-render with new page
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(data.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderFilteredTable(data); // Call renderFilteredTable to re-render with new page
      }
    }

    // دالة تعديل السجل
    function editRecord(index) {
      const record = data[index];
      if (!record) return;

      document.getElementById("service").value = record.service;
      document.getElementById("plate").value = record.plate;
      document.getElementById("region").value = record.region;
      document.getElementById("date").value = record.date;
      document.getElementById("distance").value = record.distance;
      document.getElementById("notes").value = record.notes || "";

      // حذف السجل القديم
      data.splice(index, 1);
      updateTable();
      updatePlateSelect();
    }

    // دالة حذف السجل
    function deleteRecord(index) {
      if (confirm("هل أنت متأكد من حذف هذا السجل؟")) {
        data.splice(index, 1);
        // Reset current page if no items are left on it
        if (data.length > 0 && currentPage > Math.ceil(data.length / itemsPerPage)) {
            currentPage = Math.ceil(data.length / itemsPerPage);
        } else if (data.length === 0) {
            currentPage = 1; // Or 0, depending on preference for empty table
        }
        updateTable();
        updatePlateSelect();
      }
    }

    function printSelected() {
      if (!loggedIn) {
        alert("يجب تسجيل الدخول أولاً");
        return;
      }

      const selected = Array.from(document.getElementById("plateSelect").selectedOptions).map(opt => opt.value);
      if (selected.length === 0) {
        alert("يرجى اختيار لوحة واحدة على الأقل للطباعة.");
        return;
      }

      const logo = document.getElementById("logoSelect").value;
      const selectedData = data.filter(d => selected.includes(d.plate));
      const now = new Date();
      const printDate = now.toLocaleDateString('ar-EG') + ' ' + now.toLocaleTimeString('ar-EG');
      const companySelect = document.getElementById("companySelect");
      const company = companies[companySelect.value];

      let html = `
        <div class="print-header">
          <div class="print-header-content">
            <div>
              <h1 class="print-title">طلب صيانة</h1>
              <div class="print-company-details">
                <div>السجل التجاري: <span style="display:inline-block;">${company.commercialRegister}</span></div>
                <div>الرقم الضريبي: <span style="display:inline-block;">${company.taxNumber}</span></div>
              </div>
            </div>
            <img class="print-logo" src="${logo}" alt="شعار الشركة">
          </div>
          <div class="print-date">${printDate}</div>
        </div>
        <table class="print-table">
          <thead>
            <tr>
              <th>الخدمة</th>
              <th>رقم اللوحة</th>
              <th>المنطقة</th>
              <th>تاريخ الطلب</th>
              <th>المسافة (كم)</th>
              <th>ملاحظات</th>
            </tr>
          </thead>
          <tbody>
      `;

      selectedData.forEach(item => {
        html += `
          <tr>
            <td>${item.service}</td>
            <td>${item.plate}</td>
            <td>${item.region}</td>
            <td>${item.date}</td>
            <td>${parseFloat(item.distance).toFixed(2)}</td>
            <td>${item.notes || '-'}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
        <div style="margin-top: 20px; text-align: left; font-size: 14px;">
          <p>عدد السجلات المختارة: ${selected.length}</p>
        </div>
      `;

      const printArea = document.getElementById("printArea");
      printArea.innerHTML = html;

      setTimeout(() => {
        window.print();
      }, 300);
    }

    // Excel Upload Functionality
    function handleExcelUpload() {
      if (!loggedIn) {
        alert("يجب تسجيل الدخول أولاً");
        return;
      }

      const fileInput = document.getElementById('excelUpload');
      const file = fileInput.files[0];

      if (!file) {
        alert("الرجاء اختيار ملف Excel لرفعه.");
        return;
      }

      // Check file extension to ensure it's .xlsx or .xls
      const fileName = file.name.toLowerCase();
      if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
        alert("الرجاء رفع ملف بصيغة Excel الصحيحة (.xlsx أو .xls).");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const dataBuffer = e.target.result;
          const workbook = XLSX.read(dataBuffer, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          
          // Use header: 1 to ensure headers are read from the first row as an array
          const rawJson = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

          if (rawJson.length === 0) {
              console.warn("Excel file is empty or headers not found.");
              alert("ملف Excel فارغ أو لا يحتوي على بيانات يمكن قراءتها.");
              return;
          }

          // Assuming the first row is always headers
          const headers = rawJson[0];
          const dataRows = rawJson.slice(1); // All subsequent rows are data

          console.log("Excel Headers Read (Raw):", headers); // Log raw headers for debugging

          // Manually map headers from Excel to desired internal keys
          const mappedJson = dataRows.map(row => {
              const obj = {};
              headers.forEach((header, index) => {
                  if (header === null || header === undefined) return; // Skip null/undefined headers
                  const normalizedHeader = String(header).trim().toLowerCase();
                  
                  // Explicitly map both Arabic and English forms
                  if (normalizedHeader === 'الخدمة'.toLowerCase() || normalizedHeader === 'service') obj['service'] = row[index];
                  else if (normalizedHeader === 'رقم اللوحة'.toLowerCase() || normalizedHeader === 'plate') obj['plate'] = row[index];
                  else if (normalizedHeader === 'المنطقة'.toLowerCase() || normalizedHeader === 'region') obj['region'] = row[index];
                  else if (normalizedHeader === 'تاريخ الطلب'.toLowerCase() || normalizedHeader === 'date') obj['date'] = row[index];
                  else if (normalizedHeader === 'المسافة المقطوعة (كم)'.toLowerCase() || normalizedHeader === 'distance') obj['distance'] = row[index];
                  else if (normalizedHeader === 'ملاحظات'.toLowerCase() || normalizedHeader === 'notes') obj['notes'] = row[index];
                  // else {
                  //     // Optional: log unmapped headers if you want to know which columns are ignored
                  //     console.log(`Unmapped header: '${header}' with value: '${row[index]}'`);
                  // }
              });
              return obj;
          }).filter(obj => Object.keys(obj).length > 0); // Filter out empty objects (rows with no data)

          console.log("Excel Data Read (Mapped JSON):", mappedJson); 
          
          processExcelData(mappedJson); // Pass the manually mapped JSON
        } catch (error) {
          console.error("Error reading Excel file:", error);
          alert("حدث خطأ أثناء قراءة ملف Excel. يرجى التأكد من أنه ملف صالح.");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function processExcelData(jsonData) {
      let recordsAdded = 0;

      jsonData.forEach(row => {
        const newRecord = {};
        let isValidRow = true;

        // Explicitly assign values based on expected internal keys
        newRecord.service = String(row.service || '').trim();
        newRecord.plate = String(row.plate || '').trim();
        newRecord.region = String(row.region || '').trim();
        newRecord.date = formatDateToYYYYMMDD(row.date);
        newRecord.distance = parseDistance(row.distance);
        newRecord.notes = String(row.notes || '').trim();

        // Check if all required fields are present and valid
        const requiredFields = ['service', 'plate', 'region', 'date', 'distance'];
        for (const field of requiredFields) {
          // Date field can be empty if formatDateToYYYYMMDD returned empty for invalid input
          // Distance field can be 0 if parseDistance returned 0 for invalid input, but 0 is valid.
          // We need to check if the original value leading to 0 was truly empty/invalid.
          if (!newRecord[field] || String(newRecord[field]).trim() === '') {
            if (field !== 'distance' || (field === 'distance' && isNaN(row.distance) && String(row.distance || '').trim() !== '0')) {
                 isValidRow = false;
                 console.warn(`Skipping row due to missing or empty required field: '${field}' in row:`, row);
                 break;
            }
          }
          // Special check for date if it's empty after formatting
          if (field === 'date' && newRecord[field] === '') {
             isValidRow = false;
             console.warn(`Skipping row due to invalid date format: '${row.date}' in row:`, row);
             break;
          }
        }
        
        // Add region to regionsList if new and valid
        if (isValidRow && newRecord.region && !regionsList.includes(newRecord.region)) {
            regionsList.push(newRecord.region);
        }

        if (isValidRow) {
          data.push(newRecord);
          recordsAdded++;
        }
      });

      console.log(`Successfully added ${recordsAdded} records from Excel.`);

      // After adding all valid records, update the UI
      updateRegionsDatalist(); // Update datalist with any new regions
      updateTable(); // Call updateTable to re-render the table from page 1
      updatePlateSelect();
      alert(`تم تحميل ${recordsAdded} سجل بنجاح من ملف Excel!`);
    }


    // تهيئة الصفحة عند التحميل
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById("logoSelect").addEventListener("change", function() {
        const logoUrl = this.value;
        document.getElementById("logoPreview").src = logoUrl;
      });

      // إذا كان المستخدم يحاول الوصول مباشرة للصفحة الرئيسية دون تسجيل دخول
      if (!loggedIn) {
        document.getElementById("loginSection").classList.remove("hidden");
        document.getElementById("mainContent").classList.add("hidden");
      }
      
      // Initial update for regions datalist and table
      updateRegionsDatalist();
      updateTable(); // Ensure table is rendered on initial load (though likely empty until data is added)
      updatePlateSelect(); // Ensure plate select is updated
      
      // Initial company load
      changeCompany();
    });
  </script>
</body>
</html>
