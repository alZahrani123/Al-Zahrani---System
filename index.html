<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>طلب صيانة - Maintenance Request</title>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a0ca3;
      --secondary: #4895ef;
      --accent: #4cc9f0;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --success: #38b000;
      --warning: #ffaa00;
      --danger: #ef233c;
      --radius: 12px;
      --shadow: 0 10px 20px rgba(0,0,0,0.1);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      color: var(--dark);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: var(--primary);
      margin: 20px 0 40px;
      position: relative;
      padding-bottom: 15px;
      font-weight: 700;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: var(--accent);
      border-radius: 2px;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 25px;
      margin-bottom: 30px;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .glass-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
      color: var(--primary-dark);
      font-size: 15px;
    }

    input, select {
      width: 100%;
      padding: 12px 15px;
      margin-top: 8px;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: var(--radius);
      font-size: 15px;
      transition: var(--transition);
      background: rgba(255,255,255,0.8);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      background: white;
      box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
    }

    .btn {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      margin-top: 20px;
      padding: 14px;
      font-size: 16px;
      border-radius: var(--radius);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-align: center;
      display: block;
    }

    .btn:hover {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      transform: translateY(-2px);
      box-shadow: 0 7px 14px rgba(0,0,0,0.15);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--gray) 0%, #5a6268 100%);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #5a6268 0%, var(--gray) 100%);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .col {
      flex: 1;
      min-width: 250px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 15px;
      background: white;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
    }

    table th, table td {
      border: 1px solid #e9ecef;
      padding: 15px;
      text-align: center;
    }

    table th {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    table tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .logo-preview {
      height: 120px;
      margin-top: 10px;
      display: block;
      border-radius: var(--radius);
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      object-fit: contain;
      background: white;
      padding: 5px;
      border: 2px solid #fff;
      transition: all 0.3s ease;
    }

    .logo-preview:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }

    .company-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .company-info {
      text-align: right;
    }

    .company-name {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #fff;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }

    .company-details {
      font-size: 16px;
    }

    .company-detail-item {
      margin-bottom: 8px;
      color: rgba(255,255,255,0.9);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    .company-logo {
      height: 120px;
      border-radius: var(--radius);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border: 2px solid #fff;
      background: white;
      padding: 5px;
      transition: all 0.3s ease;
    }

    .company-logo:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }

    .language-switcher {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: var(--transition);
    }

    .language-switcher:hover {
      transform: scale(1.1);
      background: var(--primary-dark);
    }

    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: rgba(255,255,255,0.95);
      padding: 40px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.3);
    }

    .login-title {
      text-align: center;
      color: var(--primary);
      margin-bottom: 30px;
      font-weight: 700;
    }

    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: var(--radius);
      text-align: center;
      font-weight: 500;
    }

    .alert-danger {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }

    .hidden {
      display: none;
    }

    /* تنسيق الطباعة */
    @media print {
      body {
        visibility: hidden;
        margin: 0;
        padding: 0;
      }

      #printArea {
        display: block !important;
        visibility: visible;
        width: 100%;
        height: auto;
        position: absolute;
        top: 0;
        right: 0;
        padding: 20px;
        background: white;
        font-family: 'Tajawal', sans-serif;
      }

      @page {
        size: A4;
        margin: 15mm;
      }

      .print-header {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
        page-break-after: avoid;
      }

      .print-header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
        page-break-inside: avoid;
      }

      .print-title {
        text-align: center;
        color: var(--primary);
        margin: 0;
        font-size: 24px;
        font-weight: bold;
        page-break-after: avoid;
      }

      .print-company-details {
        text-align: right;
        margin-top: 15px;
        font-size: 16px;
        direction: rtl;
        page-break-inside: avoid;
      }

      .print-company-details div {
        margin-bottom: 8px;
        text-align: right;
        white-space: nowrap;
      }

      .print-logo {
        height: 100px;
        page-break-inside: avoid;
      }

      .print-date {
        text-align: left;
        font-size: 14px;
        color: var(--gray);
        margin-top: 10px;
        page-break-inside: avoid;
      }

      .print-table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
        background-color: white;
        page-break-inside: avoid;
      }

      .print-table th {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        padding: 10px;
        border: 1px solid #ddd;
      }

      .print-table td {
        padding: 10px;
        border: 1px solid #ddd;
        background-color: white;
      }

      .print-table tr {
        page-break-inside: avoid;
      }

      .no-print {
        display: none !important;
      }

      /* العلامة المائية المعدلة */
      #printArea::before {
        content: "";
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 70%;
        height: 70%;
        background-image: url('https://i.imgur.com/Zavx93d.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        opacity: 0.1;
        z-index: 9999;
        pointer-events: none;
      }

      /* تجنب طباعة الصفحات الفارغة */
      .print-table + .print-table {
        page-break-before: avoid;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out forwards;
    }

    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
  </style>
</head>
<body>

  <div id="loginSection" class="login-container fade-in">
    <h2 class="login-title">نظام إدارة المركبات<br>Vehicle Management System</h2>
    <div id="loginError" class="alert alert-danger hidden">
      اسم المستخدم أو كلمة المرور غير صحيحة!<br>Invalid username or password!
    </div>
    <form id="loginForm">
      <label for="username">اسم المستخدم / Username:</label>
      <input type="text" id="username" placeholder="أدخل اسم المستخدم / Enter username" required>
      
      <label for="password">كلمة المرور / Password:</label>
      <input type="password" id="password" placeholder="أدخل كلمة المرور / Enter password" required>
      
      <button type="button" class="btn" onclick="login()">تسجيل الدخول / Login</button>
    </form>
  </div>

  <div id="mainContent" class="hidden container">
    <button id="languageSwitcher" class="language-switcher" onclick="toggleLanguage()">
      <i class="fas fa-language fa-lg"></i>
    </button>

    <h1 id="mainTitle" class="fade-in">طلب صيانة / Maintenance Request</h1>

    <div class="company-header fade-in delay-1">
      <div class="company-info">
        <div class="company-name" id="currentCompanyName">الزهراني لوجستيك / Al-Zahrani Logistics</div>
        <div class="company-details">
          <div class="company-detail-item">السجل التجاري / Commercial Register: <span id="currentCommercialRegister">123456789</span></div>
          <div class="company-detail-item">الرقم الضريبي / Tax Number: <span id="currentTaxNumber">98765432100003</span></div>
        </div>
      </div>
      <img id="mainLogo" class="company-logo" src="https://i.imgur.com/Zavx93d.png" alt="شعار الشركة / Company Logo">
    </div>

    <div class="glass-card fade-in delay-2">
      <div class="row">
        <div class="col">
          <label id="companyLabel">اختيار المؤسسة / Select Company:</label>
          <select id="companySelect" onchange="changeCompany()">
            <option value="hinda">مؤسسة هند عطية / Hinda Atiyah Est.</option>
            <option value="mim">مؤسسة ميم / Mim Est.</option>
          </select>
        </div>
        <div class="col">
          <label id="logoLabel">اختيار الشعار / Select Logo:</label>
          <select id="logoSelect">
            <option value="https://i.imgur.com/Zavx93d.png" selected>الزهراني / Al-Zahrani</option>
            <option value="https://i.imgur.com/yS26oQZ.png">ميم / Mim</option>
          </select>
          <img id="logoPreview" class="logo-preview" src="https://i.imgur.com/Zavx93d.png" alt="شعار الشركة / Company Logo">
        </div>
      </div>
    </div>

    <div class="glass-card fade-in delay-2">
      <h3 style="margin-top: 0;" id="searchTitle">بحث عن مركبة / Vehicle Search</h3>
      <div class="row">
        <div class="col">
          <input type="text" id="searchPlate" placeholder="ابحث برقم اللوحة / Search by plate number">
        </div>
        <div class="col">
          <button onclick="searchByPlate()" class="btn" id="searchButton">بحث / Search</button>
        </div>
        <div class="col">
          <button onclick="resetSearch()" class="btn btn-secondary" id="resetButton">إعادة تعيين / Reset</button>
        </div>
      </div>
    </div>

    <div class="glass-card fade-in delay-3">
      <div class="row">
        <div class="col">
          <label id="serviceLabel">الخدمة / Service:</label>
          <input type="text" id="service" placeholder="أدخل نوع الخدمة / Enter service type">
        </div>
        <div class="col">
          <label id="plateLabel">رقم اللوحة / Plate Number:</label>
          <input type="text" id="plate" placeholder="أدخل رقم اللوحة / Enter plate number">
        </div>
        <div class="col">
          <label id="regionLabel">المنطقة / Region:</label>
          <input list="regions" id="region" placeholder="اكتب أو اختر المنطقة / Type or select region">
          <datalist id="regions">
            <option value="الرياض / Riyadh">
            <option value="جدة / Jeddah">
            <option value="مكة المكرمة / Makkah">
            <option value="المدينة المنورة / Madinah">
            <option value="الدمام / Dammam">
            <option value="الخبر / Khobar">
            <option value="الظهران / Dhahran">
            <option value="بريدة / Buraidah">
            <option value="تبوك / Tabuk">
            <option value="الطائف / Taif">
            <option value="حائل / Hail">
            <option value="أبها / Abha">
            <option value="نجران / Najran">
            <option value="جازان / Jazan">
            <option value="سكاكا / Sakakah">
            <option value="عرعر / Arar">
            <option value="القريات / Qurayyat">
            <option value="النعيرية / Nairyah">
            <option value="رفحاء / Rafha">
            <option value="ضباء / Duba">
            <option value="الليث / Lith">
            <option value="القنفذة / Qunfudhah">
            <option value="بيشة / Bisha">
            <option value="محايل عسير / Muhayil Asir">
            <option value="خميس مشيط / Khamis Mushait">
            <option value="الخرج / Al Kharj">
            <option value="الدوادمي / Dawadmi">
            <option value="وادي الدواسر / Wadi ad-Dawasir">
            <option value="الأحساء / Al Ahsa">
            <option value="حفر الباطن / Hafar Al-Batin">
            <option value="القطيف / Qatif">
            <option value="ينبع / Yanbu">
            <option value="العلا / AlUla">
            <option value="رابغ / Rabigh">
            <option value="الباحة / Al Baha">
            <option value="الزلفي / Al Zulfi">
            <option value="الرس / Ar Rass">
            <option value="عنيزة / Unaizah">
            <option value="المجمعة / Al Majma'ah">
            <option value="الخفجي / Khafji">
            <option value="طريف / Turaif">
            <option value="الدرب / Ad Darb">
            <option value="صبيا / Sabya">
            <option value="أحد رفيدة / Ahad Rifaydah">
            <option value="بلجرشي / Baljurashi">
            <option value="المهد / Al Mahd">
            <option value="الوجه / Al Wajh">
            <option value="أملج / Umluj">
            <option value="بدر / Badr">
            <option value="الحريق / Al Hariq">
            <option value="حوطة بني تميم / Hotat Bani Tamim">
            <option value="الغاط / Al Ghat">
            <option value="السليل / As Sulayyil">
            <option value="ضرما / Durma">
            <option value="المزاحمية / Al Muzahimiyah">
          </datalist>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label id="dateLabel">تاريخ الطلب / Request Date:</label>
          <input type="date" id="date">
        </div>
        <div class="col">
          <label id="distanceLabel">المسافة المقطوعة (كم) / Distance (km):</label>
          <input type="number" id="distance" placeholder="أدخل المسافة بالكيلومترات / Enter distance in km">
        </div>
        <div class="col">
          <label id="notesLabel">ملاحظات / Notes:</label>
          <input type="text" id="notes" placeholder="أدخل أي ملاحظات إضافية / Enter any additional notes">
        </div>
      </div>
      <button onclick="addInvoice()" class="btn" id="addInvoiceButton">إضافة الفاتورة / Add Invoice</button>
    </div>

    <div class="glass-card fade-in delay-3">
      <div class="row">
        <div class="col">
          <label id="uploadTitle">رفع ملف Excel / Upload Excel File</label>
          <input type="file" id="excelUpload" accept=".xls, .xlsx">
        </div>
        <div class="col">
          <button onclick="handleExcelUpload()" class="btn" id="uploadButton">رفع وتحميل البيانات / Upload and Load Data</button>
        </div>
      </div>
    </div>

    <div class="glass-card fade-in delay-3">
      <div class="row">
        <div class="col">
          <label id="selectPlatesLabel">اختيار اللوحات للطباعة / Select Plates for Printing:</label>
          <select id="plateSelect" multiple size="5" style="height: 120px; width: 100%;"></select>
        </div>
        <div class="col" style="display: flex; flex-direction: column; gap: 10px;">
          <button onclick="clearPlateSelection()" class="btn btn-secondary" id="clearSelectionButton">مسح الاختيار / Clear Selection</button>
          <button onclick="printSelected()" class="btn" id="printButton">طباعة PDF / Print PDF</button>
        </div>
      </div>

      <div class="pagination">
        <button onclick="prevPage()" class="btn btn-secondary">«</button>
        <button onclick="prevPage()" class="btn btn-secondary" id="prevButton">< السابق / Previous</button>
        <span style="padding: 8px 15px; margin: 0 5px;" id="pageInfo">1 من 2 / 1 of 2</span>
        <button onclick="nextPage()" class="btn btn-secondary" id="nextButton">التالي / Next ></button>
        <button onclick="nextPage()" class="btn btn-secondary">»</button>
      </div>

      <table id="invoiceTable">
        <thead>
          <tr>
            <th id="serviceHeader">الخدمة / Service</th>
            <th id="plateHeader">رقم اللوحة / Plate</th>
            <th id="regionHeader">المنطقة / Region</th>
            <th id="dateHeader">تاريخ الطلب / Date</th>
            <th id="distanceHeader">المسافة (كم) / Distance (km)</th>
            <th id="actionsHeader">إجراءات / Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="printArea"></div>
  </div>

  <script>
    // بيانات المؤسسات
    const companies = {
      hinda: {
        name: "مؤسسة هند عطية / Hinda Atiyah Est.",
        commercialRegister: "205012619",
        taxNumber: "302120852100003",
        logo: "https://i.imgur.com/8SUC13Y.png"
      },
      mim: {
        name: "مؤسسة ميم / Mim Est.",
        commercialRegister: "4030385483",
        taxNumber: "311054471900003",
        logo: "https://i.imgur.com/yS26oQZ.png"
      }
    };

    // الترجمة
    const translations = {
      ar: {
        mainTitle: "طلب صيانة",
        companyLabel: "اختيار المؤسسة",
        logoLabel: "اختيار الشعار",
        searchTitle: "بحث عن مركبة",
        searchButton: "بحث",
        resetButton: "إعادة تعيين",
        serviceLabel: "الخدمة",
        plateLabel: "رقم اللوحة",
        regionLabel: "المنطقة",
        dateLabel: "تاريخ الطلب",
        distanceLabel: "المسافة المقطوعة (كم)",
        notesLabel: "ملاحظات",
        addInvoiceButton: "إضافة الفاتورة",
        uploadTitle: "رفع ملف Excel",
        uploadButton: "رفع وتحميل البيانات",
        selectPlatesLabel: "اختيار اللوحات للطباعة",
        printButton: "طباعة PDF",
        clearSelectionButton: "مسح الاختيار",
        prevButton: "< السابق",
        nextButton: "التالي >",
        pageInfo: "1 من 2",
        serviceHeader: "الخدمة",
        plateHeader: "رقم اللوحة",
        regionHeader: "المنطقة",
        dateHeader: "تاريخ الطلب",
        distanceHeader: "المسافة (كم)",
        actionsHeader: "إجراءات",
        loginTitle: "نظام إدارة المركبات",
        loginButton: "تسجيل الدخول",
        usernameLabel: "اسم المستخدم",
        passwordLabel: "كلمة المرور",
        loginError: "اسم المستخدم أو كلمة المرور غير صحيحة!",
        searchPlaceholder: "ابحث برقم اللوحة",
        servicePlaceholder: "أدخل نوع الخدمة",
        platePlaceholder: "أدخل رقم اللوحة",
        regionPlaceholder: "اكتب أو اختر المنطقة",
        distancePlaceholder: "أدخل المسافة بالكيلومترات",
        notesPlaceholder: "أدخل أي ملاحظات إضافية"
      },
      en: {
        mainTitle: "Maintenance Request",
        companyLabel: "Select Company",
        logoLabel: "Select Logo",
        searchTitle: "Vehicle Search",
        searchButton: "Search",
        resetButton: "Reset",
        serviceLabel: "Service",
        plateLabel: "Plate Number",
        regionLabel: "Region",
        dateLabel: "Request Date",
        distanceLabel: "Distance (km)",
        notesLabel: "Notes",
        addInvoiceButton: "Add Invoice",
        uploadTitle: "Upload Excel File",
        uploadButton: "Upload and Load Data",
        selectPlatesLabel: "Select Plates for Printing",
        printButton: "Print PDF",
        clearSelectionButton: "Clear Selection",
        prevButton: "Previous",
        nextButton: "Next >",
        pageInfo: "1 of 2",
        serviceHeader: "Service",
        plateHeader: "Plate",
        regionHeader: "Region",
        dateHeader: "Date",
        distanceHeader: "Distance (km)",
        actionsHeader: "Actions",
        loginTitle: "Vehicle Management System",
        loginButton: "Login",
        usernameLabel: "Username",
        passwordLabel: "Password",
        loginError: "Invalid username or password!",
        searchPlaceholder: "Search by plate number",
        servicePlaceholder: "Enter service type",
        platePlaceholder: "Enter plate number",
        regionPlaceholder: "Type or select region",
        distancePlaceholder: "Enter distance in km",
        notesPlaceholder: "Enter any additional notes"
      }
    };

    // البيانات العامة
    const data = [];
    let currentPage = 1;
    const itemsPerPage = 5;
    let loggedIn = false;
    let currentLanguage = 'ar';
    let regionsList = [
      "الرياض / Riyadh", "جدة / Jeddah", "مكة المكرمة / Makkah", "المدينة المنورة / Madinah", "الدمام / Dammam",
      "الخبر / Khobar", "الظهران / Dhahran", "بريدة / Buraidah", "تبوك / Tabuk", "الطائف / Taif",
      "حائل / Hail", "أبها / Abha", "نجران / Najran", "جازان / Jazan", "سكاكا / Sakakah",
      "عرعر / Arar", "القريات / Qurayyat", "النعيرية / Nairyah", "رفحاء / Rafha", "ضباء / Duba",
      "الليث / Lith", "القنفذة / Qunfudhah", "بيشة / Bisha", "محايل عسير / Muhayil Asir", "خميس مشيط / Khamis Mushait",
      "الخرج / Al Kharj", "الدوادمي / Dawadmi", "وادي الدواسر / Wadi ad-Dawasir", "الأحساء / Al Ahsa", "حفر الباطن / Hafar Al-Batin",
      "القطيف / Qatif", "ينبع / Yanbu", "العلا / AlUla", "رابغ / Rabigh", "الباحة / Al Baha",
      "الزلفي / Al Zulfi", "الرس / Ar Rass", "عنيزة / Unaizah", "المجمعة / Al Majma'ah", "الخفجي / Khafji",
      "طريف / Turaif", "الدرب / Ad Darb", "صبيا / Sabya", "أحد رفيدة / Ahad Rifaydah", "بلجرشي / Baljurashi",
      "المهد / Al Mahd", "الوجه / Al Wajh", "أملج / Umluj", "بدر / Badr", "الحريق / Al Hariq",
      "حوطة بني تميم / Hotat Bani Tamim", "الغاط / Al Ghat", "السليل / As Sulayyil", "ضرما / Durma", "المزاحمية / Al Muzahimiyah"
    ];

    // تغيير اللغة
    function toggleLanguage() {
      currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
      document.documentElement.lang = currentLanguage;
      document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
      applyTranslations();
    }

    // تطبيق الترجمة
    function applyTranslations() {
      const lang = translations[currentLanguage];
      document.getElementById('mainTitle').textContent = lang.mainTitle;
      document.getElementById('companyLabel').textContent = lang.companyLabel;
      document.getElementById('logoLabel').textContent = lang.logoLabel;
      document.getElementById('searchTitle').textContent = lang.searchTitle;
      document.getElementById('searchButton').textContent = lang.searchButton;
      document.getElementById('resetButton').textContent = lang.resetButton;
      document.getElementById('serviceLabel').textContent = lang.serviceLabel;
      document.getElementById('plateLabel').textContent = lang.plateLabel;
      document.getElementById('regionLabel').textContent = lang.regionLabel;
      document.getElementById('dateLabel').textContent = lang.dateLabel;
      document.getElementById('distanceLabel').textContent = lang.distanceLabel;
      document.getElementById('notesLabel').textContent = lang.notesLabel;
      document.getElementById('addInvoiceButton').textContent = lang.addInvoiceButton;
      document.getElementById('uploadTitle').textContent = lang.uploadTitle;
      document.getElementById('uploadButton').textContent = lang.uploadButton;
      document.getElementById('selectPlatesLabel').textContent = lang.selectPlatesLabel;
      document.getElementById('printButton').textContent = lang.printButton;
      document.getElementById('clearSelectionButton').textContent = lang.clearSelectionButton;
      document.getElementById('prevButton').textContent = lang.prevButton;
      document.getElementById('nextButton').textContent = lang.nextButton;
      document.getElementById('serviceHeader').textContent = lang.serviceHeader;
      document.getElementById('plateHeader').textContent = lang.plateHeader;
      document.getElementById('regionHeader').textContent = lang.regionHeader;
      document.getElementById('dateHeader').textContent = lang.dateHeader;
      document.getElementById('distanceHeader').textContent = lang.distanceHeader;
      document.getElementById('actionsHeader').textContent = lang.actionsHeader;
      
      // Update placeholders
      document.getElementById('searchPlate').placeholder = lang.searchPlaceholder;
      document.getElementById('service').placeholder = lang.servicePlaceholder;
      document.getElementById('plate').placeholder = lang.platePlaceholder;
      document.getElementById('region').placeholder = lang.regionPlaceholder;
      document.getElementById('distance').placeholder = lang.distancePlaceholder;
      document.getElementById('notes').placeholder = lang.notesPlaceholder;
      
      // Update login section if visible
      if (!loggedIn) {
        document.querySelector('.login-title').innerHTML = lang.loginTitle;
        document.getElementById('loginButton').textContent = lang.loginButton;
        document.getElementById('loginError').innerHTML = lang.loginError;
        document.getElementById('username').placeholder = lang.usernameLabel;
        document.getElementById('password').placeholder = lang.passwordLabel;
      }
      
      // Update page info
      updatePagination();
    }

    // دالة تسجيل الدخول
    function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      
      if (username === "مشرف" && password === "00" || username === "admin" && password === "00") {
        document.getElementById("loginError").classList.add("hidden");
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("mainContent").classList.remove("hidden");
        loggedIn = true;
      } else {
        document.getElementById("loginError").classList.remove("hidden");
      }
    }

    // تغيير المؤسسة
    function changeCompany() {
      const companySelect = document.getElementById("companySelect");
      const selectedCompany = companySelect.value;
      const company = companies[selectedCompany];
      
      document.getElementById("currentCompanyName").textContent = company.name;
      document.getElementById("currentCommercialRegister").textContent = company.commercialRegister;
      document.getElementById("currentTaxNumber").textContent = company.taxNumber;
      document.getElementById("mainLogo").src = company.logo;
      
      // تحديث الشعار
      document.getElementById("logoSelect").value = company.logo;
      document.getElementById("logoPreview").src = company.logo;
    }

    // دالة البحث برقم اللوحة
    function searchByPlate() {
      const searchTerm = document.getElementById("searchPlate").value.trim().toLowerCase();
      if (!searchTerm) {
        updateTable();
        return;
      }

      const filteredData = data.filter(item =>
        item.plate.toLowerCase().includes(searchTerm)
      );

      renderFilteredTable(filteredData);
    }

    // دالة إعادة تعيين البحث
    function resetSearch() {
      document.getElementById("searchPlate").value = "";
      updateTable();
    }

    // دالة لعرض الجدول بعد البحث
    function renderFilteredTable(filteredData) {
      const tbody = document.querySelector("#invoiceTable tbody");
      tbody.innerHTML = "";

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const paginatedData = filteredData.slice(start, end);

      paginatedData.forEach((item, index) => {
        const row = document.createElement("tr");
        // Ensure index matches the current data array, not just the paginated slice
        const actualIndex = data.findIndex(d => d === item); 
        row.innerHTML = `
          <td>${item.service}</td>
          <td>${item.plate}</td>
          <td>${item.region}</td>
          <td>${item.date}</td>
          <td>${parseFloat(item.distance).toFixed(2)}</td>
          <td>
            <button onclick="editRecord(${actualIndex})" class="action-btn edit-btn">${currentLanguage === 'ar' ? 'تعديل' : 'Edit'}</button>
            <button onclick="deleteRecord(${actualIndex})" class="action-btn delete-btn">${currentLanguage === 'ar' ? 'حذف' : 'Delete'}</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      updatePagination(filteredData.length);
    }

    // Helper function to format date
    function formatDateToYYYYMMDD(dateValue) {
        if (typeof dateValue === 'number' && !isNaN(dateValue)) {
            // Convert Excel date number (days since 1900-01-01) to JavaScript Date
            // Excel's 1900 date system considers 1900-02-29 as a valid date, which it isn't.
            // So, we subtract 1 day from the Excel date number if it's greater than 59 (Feb 28, 1900)
            // because Excel treats 1900 as a leap year.
            let days = dateValue;
            if (days > 60) { // Check for dates after Feb 28, 1900
                days--;
            }
            // Date object for Jan 1, 1900 (Excel's base date, day 1). Use UTC to avoid timezone issues.
            const excelEpoch = new Date('1900-01-01T00:00:00Z'); 
            excelEpoch.setDate(excelEpoch.getDate() + days - 1); // Subtract 1 because Excel day 1 is 1900-01-01, not 0
            
            return excelEpoch.toISOString().split('T')[0];

        } else if (typeof dateValue === 'string') {
            const parsedDate = new Date(dateValue);
            // Check for valid date string, including "yyyy-mm-dd"
            if (!isNaN(parsedDate.getTime())) {
                return parsedDate.toISOString().split('T')[0];
            }
            // Try parsing common European/Arabic formats (dd/mm/yyyy or dd-mm-yyyy) if direct parse fails
            const parts = dateValue.match(/^(\d{1,2})[/\-](\d{1,2})[/\-](\d{4})$/);
            if (parts) {
                const day = parseInt(parts[1]);
                const month = parseInt(parts[2]);
                const year = parseInt(parts[3]);
                // Assuming dd/mm/yyyy format for Arabic context
                const reParsedDate = new Date(year, month - 1, day); // Month is 0-indexed in JS
                if (!isNaN(reParsedDate.getTime())) {
                    return reParsedDate.toISOString().split('T')[0];
                }
            }
        }
        return ''; // Return empty string for invalid dates
    }

    // Helper function to parse distance
    function parseDistance(distanceValue) {
        const parsedDistance = parseFloat(distanceValue);
        return isNaN(parsedDistance) ? 0 : parsedDistance;
    }


    function addInvoice() {
      if (!loggedIn) {
        alert(currentLanguage === 'ar' ? "يجب تسجيل الدخول أولاً" : "You must login first");
        return;
      }

      const service = document.getElementById("service").value.trim();
      const plate = document.getElementById("plate").value.trim();
      const region = document.getElementById("region").value.trim();
      const date = document.getElementById("date").value; // This is already YYYY-MM-DD from input type="date"
      const distance = document.getElementById("distance").value.trim();
      const notes = document.getElementById("notes").value.trim();

      if (!service || !plate || !region || !date || !distance) {
        alert(currentLanguage === 'ar' ? "يرجى تعبئة جميع الحقول المطلوبة." : "Please fill all required fields.");
        return;
      }

      // Format date and distance for consistency
      const formattedDate = formatDateToYYYYMMDD(date);
      const parsedDistance = parseDistance(distance);

      // إذا كانت المنطقة جديدة نضيفها للقائمة
      if (!regionsList.includes(region)) {
        regionsList.push(region);
        updateRegionsDatalist();
      }

      const record = { service, plate, region, date: formattedDate, distance: parsedDistance, notes };
      data.push(record);

      updateTable();
      updatePlateSelect();

      // Reset inputs
      document.getElementById("service").value = "";
      document.getElementById("plate").value = "";
      document.getElementById("region").value = "";
      document.getElementById("date").value = "";
      document.getElementById("distance").value = "";
      document.getElementById("notes").value = "";
    }

    function updateRegionsDatalist() {
      const datalist = document.getElementById("regions");
      datalist.innerHTML = "";
      
      // Sort regions alphabetically for better user experience
      regionsList.sort().forEach(region => {
        const option = document.createElement("option");
        option.value = region;
        datalist.appendChild(option);
      });
    }

    function updateTable() {
      // Always reset current page to 1 when table data is updated
      // This ensures we start from the beginning of the new data set.
      currentPage = 1; 
      renderFilteredTable(data);
    }

    function updatePlateSelect() {
      const plateSelect = document.getElementById("plateSelect");
      plateSelect.innerHTML = "";
      
      // Get unique plates to avoid duplicates in the select dropdown
      const uniquePlates = [...new Set(data.map(item => item.plate))];
      uniquePlates.forEach(plate => {
        const option = document.createElement("option");
        option.value = plate;
        option.text = plate;
        plateSelect.appendChild(option);
      });
    }

    function updatePagination(totalItems = data.length) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      // Ensure currentPage doesn't exceed totalPages if data shrinks
      if (currentPage > totalPages && totalPages > 0) {
          currentPage = totalPages;
      } else if (totalPages === 0) { // Handle case with no data
          currentPage = 0;
      }
      const paginationText = currentLanguage === 'ar' 
          ? `${currentPage === 0 ? 0 : currentPage} من ${totalPages}` 
          : `${currentPage === 0 ? 0 : currentPage} of ${totalPages}`;
      document.querySelector(".pagination span").textContent = paginationText;
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderFilteredTable(data); // Call renderFilteredTable to re-render with new page
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(data.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderFilteredTable(data); // Call renderFilteredTable to re-render with new page
      }
    }

    // دالة مسح اختيار اللوحات
    function clearPlateSelection() {
      const plateSelect = document.getElementById("plateSelect");
      Array.from(plateSelect.options).forEach(option => {
        option.selected = false;
      });
    }

    // دالة تعديل السجل
    function editRecord(index) {
      const record = data[index];
      if (!record) return;

      document.getElementById("service").value = record.service;
      document.getElementById("plate").value = record.plate;
      document.getElementById("region").value = record.region;
      document.getElementById("date").value = record.date;
      document.getElementById("distance").value = record.distance;
      document.getElementById("notes").value = record.notes || "";

      // حذف السجل القديم
      data.splice(index, 1);
      updateTable();
      updatePlateSelect();
    }

    // دالة حذف السجل
    function deleteRecord(index) {
      if (confirm(currentLanguage === 'ar' ? "هل أنت متأكد من حذف هذا السجل؟" : "Are you sure you want to delete this record?")) {
        data.splice(index, 1);
        // Reset current page if no items are left on it
        if (data.length > 0 && currentPage > Math.ceil(data.length / itemsPerPage)) {
            currentPage = Math.ceil(data.length / itemsPerPage);
        } else if (data.length === 0) { // Handle case with no data
            currentPage = 1; // Or 0, depending on preference for empty table
        }
        updateTable();
        updatePlateSelect();
      }
    }

    function printSelected() {
      if (!loggedIn) {
        alert(currentLanguage === 'ar' ? "يجب تسجيل الدخول أولاً" : "You must login first");
        return;
      }

      const selected = Array.from(document.getElementById("plateSelect").selectedOptions).map(opt => opt.value);
      if (selected.length === 0) {
        alert(currentLanguage === 'ar' ? "يرجى اختيار لوحة واحدة على الأقل للطباعة." : "Please select at least one plate to print.");
        return;
      }

      const logo = document.getElementById("logoSelect").value;
      const selectedData = data.filter(d => selected.includes(d.plate));
      const now = new Date();
      const printDate = currentLanguage === 'ar' 
          ? now.toLocaleDateString('ar-EG') + ' ' + now.toLocaleTimeString('ar-EG')
          : now.toLocaleDateString('en-US') + ' ' + now.toLocaleTimeString('en-US');
      const companySelect = document.getElementById("companySelect");
      const company = companies[companySelect.value];

      let html = `
        <div class="print-header">
          <div class="print-header-content">
            <div>
              <h1 class="print-title">${currentLanguage === 'ar' ? 'طلب صيانة' : 'Maintenance Request'}</h1>
              <div class="print-company-details">
                <div>${currentLanguage === 'ar' ? 'السجل التجاري:' : 'Commercial Register:'} <span style="display:inline-block;">${company.commercialRegister}</span></div>
                <div>${currentLanguage === 'ar' ? 'الرقم الضريبي:' : 'Tax Number:'} <span style="display:inline-block;">${company.taxNumber}</span></div>
              </div>
            </div>
            <img class="print-logo" src="${logo}" alt="${currentLanguage === 'ar' ? 'شعار الشركة' : 'Company Logo'}">
          </div>
          <div class="print-date">${printDate}</div>
        </div>
        <table class="print-table">
          <thead>
            <tr>
              <th>${currentLanguage === 'ar' ? 'الخدمة' : 'Service'}</th>
              <th>${currentLanguage === 'ar' ? 'رقم اللوحة' : 'Plate Number'}</th>
              <th>${currentLanguage === 'ar' ? 'المنطقة' : 'Region'}</th>
              <th>${currentLanguage === 'ar' ? 'تاريخ الطلب' : 'Request Date'}</th>
              <th>${currentLanguage === 'ar' ? 'المسافة (كم)' : 'Distance (km)'}</th>
              <th>${currentLanguage === 'ar' ? 'ملاحظات' : 'Notes'}</th>
            </tr>
          </thead>
          <tbody>
      `;

      selectedData.forEach(item => {
        html += `
          <tr>
            <td>${item.service}</td>
            <td>${item.plate}</td>
            <td>${item.region}</td>
            <td>${item.date}</td>
            <td>${parseFloat(item.distance).toFixed(2)}</td>
            <td>${item.notes || '-'}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      const printArea = document.getElementById("printArea");
      printArea.innerHTML = html;

      setTimeout(() => {
        window.print();
      }, 300);
    }

    // Excel Upload Functionality
    function handleExcelUpload() {
      if (!loggedIn) {
        alert(currentLanguage === 'ar' ? "يجب تسجيل الدخول أولاً" : "You must login first");
        return;
      }

      const fileInput = document.getElementById('excelUpload');
      const file = fileInput.files[0];

      if (!file) {
        alert(currentLanguage === 'ar' ? "الرجاء اختيار ملف Excel لرفعه." : "Please select an Excel file to upload.");
        return;
      }

      // Check file extension to ensure it's .xlsx or .xls
      const fileName = file.name.toLowerCase();
      if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
        alert(currentLanguage === 'ar' ? "الرجاء رفع ملف بصيغة Excel الصحيحة (.xlsx أو .xls)." : "Please upload a valid Excel file (.xlsx or .xls).");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const dataBuffer = e.target.result;
          const workbook = XLSX.read(dataBuffer, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          
          // Use header: 1 to ensure headers are read from the first row as an array
          const rawJson = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

          if (rawJson.length === 0) {
              console.warn("Excel file is empty or headers not found.");
              alert(currentLanguage === 'ar' ? "ملف Excel فارغ أو لا يحتوي على بيانات يمكن قراءتها." : "Excel file is empty or contains no readable data.");
              return;
          }

          // Assuming the first row is always headers
          const headers = rawJson[0];
          const dataRows = rawJson.slice(1); // All subsequent rows are data

          console.log("Excel Headers Read (Raw):", headers); // Log raw headers for debugging

          // Manually map headers from Excel to desired internal keys
          const mappedJson = dataRows.map(row => {
              const obj = {};
              headers.forEach((header, index) => {
                  if (header === null || header === undefined) return; // Skip null/undefined headers
                  const normalizedHeader = String(header).trim().toLowerCase();
                  
                  // Explicitly map both Arabic and English forms
                  if (normalizedHeader === 'الخدمة'.toLowerCase() || normalizedHeader === 'service') obj['service'] = row[index];
                  else if (normalizedHeader === 'رقم اللوحة'.toLowerCase() || normalizedHeader === 'plate') obj['plate'] = row[index];
                  else if (normalizedHeader === 'المنطقة'.toLowerCase() || normalizedHeader === 'region') obj['region'] = row[index];
                  else if (normalizedHeader === 'تاريخ الطلب'.toLowerCase() || normalizedHeader === 'date') obj['date'] = row[index];
                  else if (normalizedHeader === 'المسافة المقطوعة (كم)'.toLowerCase() || normalizedHeader === 'distance') obj['distance'] = row[index];
                  else if (normalizedHeader === 'ملاحظات'.toLowerCase() || normalizedHeader === 'notes') obj['notes'] = row[index];
              });
              return obj;
          }).filter(obj => Object.keys(obj).length > 0); // Filter out empty objects (rows with no data)

          console.log("Excel Data Read (Mapped JSON):", mappedJson); 
          
          processExcelData(mappedJson); // Pass the manually mapped JSON
        } catch (error) {
          console.error("Error reading Excel file:", error);
          alert(currentLanguage === 'ar' ? "حدث خطأ أثناء قراءة ملف Excel. يرجى التأكد من أنه ملف صالح." : "Error reading Excel file. Please ensure it's a valid file.");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function processExcelData(jsonData) {
      let recordsAdded = 0;

      jsonData.forEach(row => {
        const newRecord = {};
        let isValidRow = true;

        // Explicitly assign values based on expected internal keys
        newRecord.service = String(row.service || '').trim();
        newRecord.plate = String(row.plate || '').trim();
        newRecord.region = String(row.region || '').trim();
        newRecord.date = formatDateToYYYYMMDD(row.date);
        newRecord.distance = parseDistance(row.distance);
        newRecord.notes = String(row.notes || '').trim();

        // Check if all required fields are present and valid
        const requiredFields = ['service', 'plate', 'region', 'date', 'distance'];
        for (const field of requiredFields) {
          // Date field can be empty if formatDateToYYYYMMDD returned empty for invalid input
          // Distance field can be 0 if parseDistance returned 0 for invalid input, but 0 is valid.
          // We need to check if the original value leading to 0 was truly empty/invalid.
          if (!newRecord[field] || String(newRecord[field]).trim() === '') {
            if (field !== 'distance' || (field === 'distance' && isNaN(row.distance) && String(row.distance || '').trim() !== '0')) {
                 isValidRow = false;
                 console.warn(`Skipping row due to missing or empty required field: '${field}' in row:`, row);
                 break;
            }
          }
          // Special check for date if it's empty after formatting
          if (field === 'date' && newRecord[field] === '') {
             isValidRow = false;
             console.warn(`Skipping row due to invalid date format: '${row.date}' in row:`, row);
             break;
          }
        }
        
        // Add region to regionsList if new and valid
        if (isValidRow && newRecord.region && !regionsList.includes(newRecord.region)) {
            regionsList.push(newRecord.region);
        }

        if (isValidRow) {
          data.push(newRecord);
          recordsAdded++;
        }
      });

      console.log(`Successfully added ${recordsAdded} records from Excel.`);

      // After adding all valid records, update the UI
      updateRegionsDatalist(); // Update datalist with any new regions
      updateTable(); // Call updateTable to re-render the table from page 1
      updatePlateSelect();
      alert(currentLanguage === 'ar' 
          ? `تم تحميل ${recordsAdded} سجل بنجاح من ملف Excel!` 
          : `Successfully loaded ${recordsAdded} records from Excel file!`);
    }


    // تهيئة الصفحة عند التحميل
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById("logoSelect").addEventListener("change", function() {
        const logoUrl = this.value;
        document.getElementById("logoPreview").src = logoUrl;
        document.getElementById("mainLogo").src = logoUrl;
      });

      // إذا كان المستخدم يحاول الوصول مباشرة للصفحة الرئيسية دون تسجيل دخول
      if (!loggedIn) {
        document.getElementById("loginSection").classList.remove("hidden");
        document.getElementById("mainContent").classList.add("hidden");
      }
      
      // Initial update for regions datalist and table
      updateRegionsDatalist();
      updateTable(); // Ensure table is rendered on initial load (though likely empty until data is added)
      updatePlateSelect(); // Ensure plate select is updated
      
      // Initial company load
      changeCompany();
      
      // Apply translations
      applyTranslations();
    });
  </script>
</body>
</html>
