<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>طلب صيانة</title>
  <style>
    body {
      font-family: 'Tahoma', sans-serif;
      background-color: #f4f6fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #003366;
      margin-bottom: 30px;
      border-bottom: 2px solid #003366;
      padding-bottom: 10px;
    }

    .form-section, .invoice-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }

    button {
      background-color: #003366;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      margin-top: 15px;
      padding: 12px;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #004080;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .col {
      flex: 1;
      min-width: 200px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 16px;
    }

    table th, table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }

    table th {
      background-color: #003366;
      color: white;
      font-weight: bold;
    }

    table tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    .logo-preview {
      height: 100px;
      margin-top: 10px;
      display: block;
    }

    #printArea {
      display: none;
    }

    .pagination {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .pagination button {
      width: auto;
      padding: 8px 15px;
      margin: 0 5px;
    }

    .login-container {
      max-width: 400px;
      margin: 50px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .login-title {
      text-align: center;
      color: #003366;
      margin-bottom: 20px;
    }

    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid transparent;
      border-radius: 4px;
      text-align: center;
    }

    .alert-danger {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }

    .hidden {
      display: none;
    }

    .datalist-input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }

    /* تنسيق معلومات المؤسسة */
    .company-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(to right, #003366, #004080);
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .company-info {
      text-align: right;
    }

    .company-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .company-details {
      font-size: 16px;
    }

    .company-detail-item {
      margin-bottom: 5px;
      direction: rtl;
      text-align: right;
    }

    .company-detail-item span {
      float: left;
      margin-left: 10px;
    }

    .company-logo {
      height: 100px;
    }

    /* تنسيق الطباعة */
    @media print {
      body {
        visibility: hidden;
        margin: 0;
        padding: 0;
      }

      #printArea {
        display: block !important;
        visibility: visible;
        width: 100%;
        height: auto;
        position: absolute;
        top: 0;
        right: 0;
        padding: 20px;
        background: white;
      }

      @page {
        size: A4;
        margin: 15mm;
      }

      /* إزالة الروابط من الطباعة */
      a, a:link, a:visited, a:hover, a:active {
        display: none !important;
      }

      .print-header {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
      }

      .print-header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
      }

      .print-title {
        text-align: center;
        color: #003366;
        margin: 0;
        font-size: 24px;
      }

      .print-company-details {
        text-align: right;
        margin-top: 15px;
        font-size: 16px;
        direction: rtl;
      }

      .print-company-details div {
        margin-bottom: 8px;
        text-align: right;
      }

      .print-company-details div span {
        float: left;
        margin-left: 10px;
      }

      .print-logo {
        height: 100px;
      }

      .print-date {
        text-align: left;
        font-size: 14px;
        color: #666;
        margin-top: 10px;
      }

      .print-table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
        background-color: white;
      }

      .print-table th {
        background-color: #003366 !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        padding: 10px;
        border: 1px solid #ddd;
      }

      .print-table td {
        padding: 10px;
        border: 1px solid #ddd;
        background-color: white;
      }

      .no-print {
        display: none !important;
      }
    }
  </style>
</head>
<body>

  <!-- نظام تسجيل الدخول -->
  <div id="loginSection" class="login-container">
    <h2 class="login-title">نظام إدارة المركبات</h2>
    <div id="loginError" class="alert alert-danger hidden">
      اسم المستخدم أو كلمة المرور غير صحيحة!
    </div>
    <form id="loginForm">
      <label for="username">اسم المستخدم:</label>
      <input type="text" id="username" placeholder="أدخل اسم المستخدم" required>
      
      <label for="password">كلمة المرور:</label>
      <input type="password" id="password" placeholder="أدخل كلمة المرور" required>
      
      <button type="button" onclick="login()">تسجيل الدخول</button>
    </form>
  </div>

  <!-- نظام إدارة المركبات -->
  <div id="mainContent" class="hidden">
    <!-- عنوان الصفحة -->
    <h1>طلب صيانة</h1>

    <!-- معلومات المؤسسة -->
    <div class="company-header">
      <div class="company-info">
        <div class="company-name" id="currentCompanyName">مؤسسة هند عطية</div>
        <div class="company-details">
          <div class="company-detail-item">السجل التجاري: <span id="currentCommercialRegister">205012519</span></div>
          <div class="company-detail-item">الرقم الضريبي: <span id="currentTaxNumber">302120852100003</span></div>
        </div>
      </div>
      <img id="mainLogo" class="company-logo" src="https://i.imgur.com/8SUC13Y.png" alt="شعار الشركة">
    </div>

    <!-- اختيار المؤسسة -->
    <div class="form-section">
      <div class="row">
        <div class="col">
          <label>اختيار المؤسسة:</label>
          <select id="companySelect" onchange="changeCompany()">
            <option value="hinda">مؤسسة هند عطية</option>
            <option value="mim">مؤسسة ميم</option>
          </select>
        </div>
        <div class="col">
          <label>اختيار الشعار:</label>
          <select id="logoSelect">
            <option value="https://i.imgur.com/8SUC13Y.png">الزهراني</option>
            <option value="https://i.imgur.com/yS26oQZ.png">ميم</option>
          </select>
          <img id="logoPreview" class="logo-preview" src="https://i.imgur.com/8SUC13Y.png" alt="شعار الشركة">
        </div>
      </div>
    </div>

    <!-- قسم البحث -->
    <div class="search-section">
      <h3 style="margin-top: 0;">بحث عن مركبة</h3>
      <div class="search-row">
        <input type="text" id="searchPlate" placeholder="ابحث برقم اللوحة">
        <button onclick="searchByPlate()">بحث</button>
        <button onclick="resetSearch()" style="background: #6c757d;">إعادة تعيين</button>
      </div>
    </div>

    <!-- نموذج إدخال البيانات -->
    <div class="form-section">
      <div class="row">
        <div class="col">
          <label>الخدمة:</label>
          <input type="text" id="service" placeholder="أدخل نوع الخدمة">
        </div>
        <div class="col">
          <label>رقم اللوحة:</label>
          <input type="text" id="plate" placeholder="أدخل رقم اللوحة">
        </div>
        <div class="col">
          <label>المنطقة:</label>
          <input list="regions" id="region" class="datalist-input" placeholder="اكتب أو اختر المنطقة">
          <datalist id="regions">
            <option value="الرياض">
            <option value="جدة">
            <option value="مكة المكرمة">
            <option value="المدينة المنورة">
            <option value="الدمام">
            <option value="الخبر">
            <option value="الظهران">
            <option value="بريدة">
            <option value="تبوك">
            <option value="الطائف">
            <option value="حائل">
            <option value="أبها">
            <option value="نجران">
            <option value="جازان">
            <option value="سكاكا">
            <option value="عرعر">
            <option value="القريات">
            <option value="النعيرية">
            <option value="رفحاء">
            <option value="ضباء">
            <option value="الليث">
            <option value="القنفذة">
            <option value="بيشة">
            <option value="محايل عسير">
            <option value="خميس مشيط">
            <option value="الخرج">
            <option value="الدوادمي">
            <option value="وادي الدواسر">
            <option value="الأحساء">
            <option value="حفر الباطن">
            <option value="القطيف">
            <option value="ينبع">
            <option value="العلا">
            <option value="رابغ">
            <option value="الباحة">
            <option value="الزلفي">
            <option value="الرس">
            <option value="عنيزة">
            <option value="المجمعة">
            <option value="الخفجي">
            <option value="طريف">
            <option value="الدرب">
            <option value="صبيا">
            <option value="أحد رفيدة">
            <option value="بلجرشي">
            <option value="المهد">
            <option value="الوجه">
            <option value="أملج">
            <option value="بدر">
            <option value="الحريق">
            <option value="حوطة بني تميم">
            <option value="الغاط">
            <option value="السليل">
            <option value="ضرما">
            <option value="المزاحمية">
          </datalist>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>تاريخ الطلب:</label>
          <input type="date" id="date">
        </div>
        <div class="col">
          <label>المسافة المقطوعة (كم):</label>
          <input type="number" id="distance" placeholder="أدخل المسافة بالكيلومترات">
        </div>
        <div class="col">
          <label>ملاحظات:</label>
          <input type="text" id="notes" placeholder="أدخل أي ملاحظات إضافية">
        </div>
      </div>
      <button onclick="addInvoice()">إضافة الفاتورة</button>
    </div>

    <!-- قسم الفواتير -->
    <div class="invoice-section">
      <div class="row">
        <div class="col">
          <label>اختيار اللوحات للطباعة:</label>
          <select id="plateSelect" multiple size="5" style="height: 120px; width: 100%;"></select>
        </div>
        <div class="col" style="display: flex; align-items: flex-end;">
          <button onclick="printSelected()" style="width: 100%;">طباعة PDF</button>
        </div>
      </div>

      <div class="pagination">
        <button onclick="prevPage()">«</button>
        <button onclick="prevPage()">< السابق</button>
        <span style="padding: 8px 15px; margin: 0 5px;">1 من 2</span>
        <button onclick="nextPage()">التالي ></button>
        <button onclick="nextPage()">»</button>
      </div>

      <table id="invoiceTable">
        <thead>
          <tr>
            <th>الخدمة</th>
            <th>رقم اللوحة</th>
            <th>المنطقة</th>
            <th>تاريخ الطلب</th>
            <th>المسافة (كم)</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="printArea"></div>
  </div>

  <script>
    // بيانات المؤسسات
    const companies = {
      hinda: {
        name: "مؤسسة هند عطية",
        commercialRegister: "205012519",
        taxNumber: "302120852100003",
        logo: "https://i.imgur.com/8SUC13Y.png"
      },
      mim: {
        name: "مؤسسة ميم",
        commercialRegister: "305012519",
        taxNumber: "402120852100003",
        logo: "https://i.imgur.com/yS26oQZ.png"
      }
    };

    // البيانات العامة
    const data = [];
    let currentPage = 1;
    const itemsPerPage = 5;
    let loggedIn = false;
    let regionsList = [
      "الرياض", "جدة", "مكة المكرمة", "المدينة المنورة", "الدمام", 
      "الخبر", "الظهران", "بريدة", "تبوك", "الطائف", 
      "حائل", "أبها", "نجران", "جازان", "سكاكا", 
      "عرعر", "القريات", "النعيرية", "رفحاء", "ضباء", 
      "الليث", "القنفذة", "بيشة", "محايل عسير", "خميس مشيط", 
      "الخرج", "الدوادمي", "وادي الدواسر", "الأحساء", "حفر الباطن", 
      "القطيف", "ينبع", "العلا", "رابغ", "الباحة", 
      "الزلفي", "الرس", "عنيزة", "المجمعة", "الخفجي", 
      "طريف", "الدرب", "صبيا", "أحد رفيدة", "بلجرشي", 
      "المهد", "الوجه", "أملج", "بدر", "الحريق", 
      "حوطة بني تميم", "الغاط", "السليل", "ضرما", "المزاحمية"
    ];

    // دالة تسجيل الدخول
    function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      
      if (username === "مشرف" && password === "00") {
        document.getElementById("loginError").classList.add("hidden");
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("mainContent").classList.remove("hidden");
        loggedIn = true;
      } else {
        document.getElementById("loginError").classList.remove("hidden");
      }
    }

    // تغيير المؤسسة
    function changeCompany() {
      const companySelect = document.getElementById("companySelect");
      const selectedCompany = companySelect.value;
      const company = companies[selectedCompany];
      
      document.getElementById("currentCompanyName").textContent = company.name;
      document.getElementById("currentCommercialRegister").textContent = company.commercialRegister;
      document.getElementById("currentTaxNumber").textContent = company.taxNumber;
      document.getElementById("mainLogo").src = company.logo;
      
      // تحديث الشعار
      document.getElementById("logoSelect").value = company.logo;
      document.getElementById("logoPreview").src = company.logo;
    }

    // دالة البحث برقم اللوحة
    function searchByPlate() {
      const searchTerm = document.getElementById("searchPlate").value.trim().toLowerCase();
      if (!searchTerm) {
        updateTable();
        return;
      }

      const filteredData = data.filter(item => 
        item.plate.toLowerCase().includes(searchTerm)
      );

      renderFilteredTable(filteredData);
    }

    // دالة إعادة تعيين البحث
    function resetSearch() {
      document.getElementById("searchPlate").value = "";
      updateTable();
    }

    // دالة لعرض الجدول بعد البحث
    function renderFilteredTable(filteredData) {
      const tbody = document.querySelector("#invoiceTable tbody");
      tbody.innerHTML = "";

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const paginatedData = filteredData.slice(start, end);

      paginatedData.forEach((item, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.service}</td>
          <td>${item.plate}</td>
          <td>${item.region}</td>
          <td>${item.date}</td>
          <td>${parseFloat(item.distance).toFixed(2)}</td>
          <td>
            <button onclick="editRecord(${index})" class="action-btn edit-btn">تعديل</button>
            <button onclick="deleteRecord(${index})" class="action-btn delete-btn">حذف</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      updatePagination(filteredData.length);
    }

    function addInvoice() {
      if (!loggedIn) {
        alert("يجب تسجيل الدخول أولاً");
        return;
      }

      const service = document.getElementById("service").value.trim();
      const plate = document.getElementById("plate").value.trim();
      const region = document.getElementById("region").value.trim();
      const date = document.getElementById("date").value;
      const distance = document.getElementById("distance").value.trim();
      const notes = document.getElementById("notes").value.trim();

      if (!service || !plate || !region || !date || !distance) {
        alert("يرجى تعبئة جميع الحقول المطلوبة.");
        return;
      }

      // إذا كانت المنطقة جديدة نضيفها للقائمة
      if (!regionsList.includes(region)) {
        regionsList.push(region);
        updateRegionsDatalist();
      }

      const record = { service, plate, region, date, distance, notes };
      data.push(record);

      updateTable();
      updatePlateSelect();

      // Reset inputs
      document.getElementById("service").value = "";
      document.getElementById("plate").value = "";
      document.getElementById("region").value = "";
      document.getElementById("date").value = "";
      document.getElementById("distance").value = "";
      document.getElementById("notes").value = "";
    }

    function updateRegionsDatalist() {
      const datalist = document.getElementById("regions");
      datalist.innerHTML = "";
      
      regionsList.forEach(region => {
        const option = document.createElement("option");
        option.value = region;
        datalist.appendChild(option);
      });
    }

    function updateTable() {
      renderFilteredTable(data);
    }

    function updatePlateSelect() {
      const plateSelect = document.getElementById("plateSelect");
      plateSelect.innerHTML = "";
      
      data.forEach(item => {
        const option = document.createElement("option");
        option.value = item.plate;
        option.text = item.plate;
        plateSelect.appendChild(option);
      });
    }

    function updatePagination(totalItems = data.length) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const paginationText = `${currentPage} من ${totalPages}`;
      document.querySelector(".pagination span").textContent = paginationText;
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        updateTable();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(data.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        updateTable();
      }
    }

    // دالة تعديل السجل
    function editRecord(index) {
      const record = data[index];
      if (!record) return;

      document.getElementById("service").value = record.service;
      document.getElementById("plate").value = record.plate;
      document.getElementById("region").value = record.region;
      document.getElementById("date").value = record.date;
      document.getElementById("distance").value = record.distance;
      document.getElementById("notes").value = record.notes || "";

      // حذف السجل القديم
      data.splice(index, 1);
      updateTable();
      updatePlateSelect();
    }

    // دالة حذف السجل
    function deleteRecord(index) {
      if (confirm("هل أنت متأكد من حذف هذا السجل؟")) {
        data.splice(index, 1);
        updateTable();
        updatePlateSelect();
      }
    }

    function printSelected() {
      if (!loggedIn) {
        alert("يجب تسجيل الدخول أولاً");
        return;
      }

      const selected = Array.from(document.getElementById("plateSelect").selectedOptions).map(opt => opt.value);
      if (selected.length === 0) {
        alert("يرجى اختيار لوحة واحدة على الأقل للطباعة.");
        return;
      }

      const logo = document.getElementById("logoSelect").value;
      const selectedData = data.filter(d => selected.includes(d.plate));
      const now = new Date();
      const printDate = now.toLocaleDateString('ar-EG') + ' ' + now.toLocaleTimeString('ar-EG');
      const companySelect = document.getElementById("companySelect");
      const company = companies[companySelect.value];

      let html = `
        <div class="print-header">
          <div class="print-header-content">
            <div>
              <h1 class="print-title">طلب صيانة</h1>
              <div class="print-company-details">
                <div>السجل التجاري: <span>${company.commercialRegister}</span></div>
                <div>الرقم الضريبي: <span>${company.taxNumber}</span></div>
              </div>
            </div>
            <img class="print-logo" src="${logo}" alt="شعار الشركة">
          </div>
          <div class="print-date">${printDate}</div>
        </div>
        <table class="print-table">
          <thead>
            <tr>
              <th>الخدمة</th>
              <th>رقم اللوحة</th>
              <th>المنطقة</th>
              <th>تاريخ الطلب</th>
              <th>المسافة (كم)</th>
              <th>ملاحظات</th>
            </tr>
          </thead>
          <tbody>
      `;

      selectedData.forEach(item => {
        html += `
          <tr>
            <td>${item.service}</td>
            <td>${item.plate}</td>
            <td>${item.region}</td>
            <td>${item.date}</td>
            <td>${parseFloat(item.distance).toFixed(2)}</td>
            <td>${item.notes || '-'}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
        <div style="margin-top: 20px; text-align: left; font-size: 14px;">
          <p>عدد السجلات المختارة: ${selected.length}</p>
        </div>
      `;

      const printArea = document.getElementById("printArea");
      printArea.innerHTML = html;

      setTimeout(() => {
        window.print();
      }, 300);
    }

    // تهيئة الصفحة عند التحميل
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById("logoSelect").addEventListener("change", function() {
        const logoUrl = this.value;
        document.getElementById("logoPreview").src = logoUrl;
      });

      // إذا كان المستخدم يحاول الوصول مباشرة للصفحة الرئيسية دون تسجيل دخول
      if (!loggedIn) {
        document.getElementById("loginSection").classList.remove("hidden");
        document.getElementById("mainContent").classList.add("hidden");
      }
    });
  </script>
</body>
</html>
      setTimeout(() => {
        window.print();
      }, 300);
    }
  </script>
</body>
</html>
